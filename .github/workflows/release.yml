name: Build and Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      tag:
        description: "Release tag (e.g., v1.2.3)"
        required: true

permissions:
  contents: write

jobs:
  build-release:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET 8
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Install Inno Setup
        run: choco install innosetup -y

      - name: Resolve version
        id: version
        shell: pwsh
        run: |
          $tag = "${{ github.event.inputs.tag }}"
          if ([string]::IsNullOrWhiteSpace($tag)) {
            $tag = "${{ github.ref_name }}"
          }
          if ($tag.StartsWith("v")) { $version = $tag.Substring(1) } else { $version = $tag }
          "RELEASE_TAG=$tag" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          "APP_VERSION=$version" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          Write-Host "Release tag: $tag"
          Write-Host "App version: $version"

      - name: Update build version
        shell: pwsh
        run: |
          $path = "build.config.ps1"
          if (Test-Path $path) {
            $content = Get-Content $path -Raw
            # Use ${1}/${2} to avoid $11 ambiguity in regex replacement
            $content = $content -replace '(\$AppVersion\s*=\s*")[^"]*(")', "`${1}$env:APP_VERSION`${2}"
            Set-Content -Path $path -Value $content -NoNewline
          }

      - name: Build self-contained release
        shell: pwsh
        run: |
          .\scripts\build.ps1 -Release

      - name: Publish framework-dependent build
        shell: pwsh
        run: |
          $frameworkDir = Join-Path $pwd "dist-framework"
          if (Test-Path $frameworkDir) { Remove-Item $frameworkDir -Recurse -Force }
          $publishDir = Join-Path $frameworkDir "publish"
          dotnet publish "src\PingTunnelVPN.App\PingTunnelVPN.App.csproj" `
            -c Release `
            -r win-x64 `
            --self-contained false `
            -p:PublishSingleFile=true `
            -o $publishDir

      - name: Package artifacts
        shell: pwsh
        run: |
          $root = $pwd
          $artifacts = Join-Path $root "artifacts"
          if (Test-Path $artifacts) { Remove-Item $artifacts -Recurse -Force }
          New-Item -ItemType Directory -Path $artifacts | Out-Null

          # Self-contained output (from dist)
          $dist = Join-Path $root "dist"
          $selfExe = Get-ChildItem -Path $dist -Filter "*.exe" | Where-Object { $_.Name -notlike "*pingtunnel*" -and $_.Name -notlike "*tun2socks*" } | Select-Object -First 1
          if (-not $selfExe) { throw "Self-contained exe not found in dist" }

          # Framework-dependent output
          $fwPublish = Join-Path $root "dist-framework\\publish"
          $fwExe = Get-ChildItem -Path $fwPublish -Filter "*.exe" | Where-Object { $_.Name -notlike "*pingtunnel*" -and $_.Name -notlike "*tun2socks*" } | Select-Object -First 1
          if (-not $fwExe) { throw "Framework-dependent exe not found in dist-framework publish" }

          # Portable self-contained (single exe)
          $portableSelf = Join-Path $artifacts "portable-selfcontained"
          New-Item -ItemType Directory -Path $portableSelf | Out-Null
          Copy-Item -Path $selfExe.FullName -Destination (Join-Path $portableSelf $selfExe.Name)

          # Portable framework-dependent (full publish output)
          $portableFw = Join-Path $artifacts "portable-framework"
          New-Item -ItemType Directory -Path $portableFw | Out-Null
          Copy-Item -Path (Join-Path $fwPublish "*") -Destination $portableFw -Recurse -Force

          # Installer staging (self-contained exe + resources)
          $installerFiles = Join-Path $artifacts "installer-files"
          New-Item -ItemType Directory -Path $installerFiles | Out-Null
          Copy-Item -Path $selfExe.FullName -Destination (Join-Path $installerFiles $selfExe.Name)
          $resourcesDir = Join-Path $dist "Resources"
          if (Test-Path $resourcesDir) {
            Copy-Item -Path $resourcesDir -Destination (Join-Path $installerFiles "Resources") -Recurse -Force
          }

          # Zip portable outputs
          $selfZip = Join-Path $artifacts ("PingTunnelVPN-selfcontained-" + $env:APP_VERSION + ".zip")
          $fwZip = Join-Path $artifacts ("PingTunnelVPN-framework-" + $env:APP_VERSION + ".zip")
          Compress-Archive -Path (Join-Path $portableSelf "*") -DestinationPath $selfZip
          Compress-Archive -Path (Join-Path $portableFw "*") -DestinationPath $fwZip

          # Copy exe assets
          Copy-Item -Path $selfExe.FullName -Destination (Join-Path $artifacts ("PingTunnelVPN-selfcontained-" + $env:APP_VERSION + ".exe"))
          Copy-Item -Path $fwExe.FullName -Destination (Join-Path $artifacts ("PingTunnelVPN-framework-" + $env:APP_VERSION + ".exe"))

      - name: Build installer
        shell: pwsh
        run: |
          $iscc = (Get-Command ISCC.exe -ErrorAction SilentlyContinue)?.Source
          if (-not $iscc) { $iscc = "${env:ProgramFiles(x86)}\\Inno Setup 6\\ISCC.exe" }
          if (-not (Test-Path $iscc)) { throw "ISCC.exe not found" }

          $installerFiles = Resolve-Path "artifacts\\installer-files"
          $selfExe = Get-ChildItem -Path $installerFiles -Filter "*.exe" | Select-Object -First 1
          if (-not $selfExe) { throw "Installer exe not found in installer-files" }

          & $iscc `
            "/DAppVersion=$env:APP_VERSION" `
            "/DAppExeName=$($selfExe.Name)" `
            "/DSourceDir=$installerFiles" `
            "installer\\PingTunnelVPN.iss"

      - name: Create GitHub release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.RELEASE_TAG }}
          files: |
            artifacts/*.exe
            artifacts/*.zip
